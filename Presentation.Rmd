---
title: "Study of the efficacy of Berenil applied to trypanosomosis's infected cattle"
author: "Gerard Castell√†, Mathieu Marauri and Lluis Ramon"
date: "March 27th, 2015"
output: 
  beamer_presentation:
    theme: Berlin
    colortheme: "default"
    fonttheme: "default"
---

```{r, echo = FALSE, warning = FALSE, message = FALSE}
library("knitr")
library("ggplot2")
library("xtable")
library("dplyr")
library("nlme")
opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE)
```

```{r}
cows <- read.table("data/cattle_mes dades.txt", header = TRUE, 
                   sep = "\t", dec = ",", na.strings = "")

names(cows) <- c("id", "dose", "pcv", "time", "nbirth")
cows$dose <- factor(cows$dose, levels = c("L", "M", "H"))
cows$doseExt <- factor(cows$dose, labels = c("Low", "Medium", "High"))
```


# Introduction

The trypanosomosis's parasite is responsible for a disease that affects cows.

Effects of the disease:

* anemia
* loss of appetite
* death

# Objective

The objective:

> Assess the efficacy of different doses of Berenil in infected cattle.

# Dataset

* 10 cows
* response variable: PCV
* covariates: _dose_, _time_, _nbirth_
* 3 dose levels (High, Medium, Low)
* idDose

# Assumptions

TODO(LLuis): Plot 

# Statistical methods

* Multivariate model
* Two-stage analysis
* Linear mixed model

# Summary statistics

```{r qplot, fig.cap = "PCV evolution for each cow on every dose. Cows are colored in the same fashion for each dose. \\label{fig:qplot}", fig.pos = "H", fig.height = 3, fig.width = 7}
qplot(factor(time), pcv, data = cows, group = id, geom = "line", facets = .~ doseExt, 
      colour = factor(id)) + scale_color_discrete(guide = 'none') + xlab("time") + ylab("PCV value")
```

# Summary statistics

TODO: Center the figure.

```{r boxplot, fig.cap = "Boxplot of PCV values for each time and dose. \\label{fig:boxplot_time_dose}", fig.pos = "H", fig.height = 4, fig.width = 6}
cows$timeDose <- paste(cows$time, cows$dose, sep = ".")
cows$timeDose <- factor(cows$timeDose, levels = c("1.L", "2.L", "3.L", "1.M", "2.M", "3.M", "1.H", "2.H", "3.H"))
ggplot(aes(timeDose, pcv, fill = doseExt), data = cows) + geom_boxplot() +
  xlab("time") + ylab("PCV value") + scale_x_discrete(labels = c(1:3)) +
   theme(legend.title=element_blank())
cows$timeDose <- NULL
```

# Summary statistics

```{r, results = 'asis'}
cows.com <- na.omit(cows)
missingsTable <- 10 - table(cows.com$dose, cows.com$time)
print(xtable(missingsTable, digits = 0, caption = "Number of missing values in PCV for time and dose"), comment = FALSE, , table.placement = "H")
```


# Multivariate models

\pause

> - Not the optimal method. 

> - Id not included in the model. 

> - Forward selection method was used (F-tests for comparisons).

> - Model specification: 
  
  \pause 
\vspace{-1cm}
\begin{align*}
PCV_i= \beta_0 + \beta_1time +\beta_2doseMedium + \beta_3doseHigh + \beta_4nbirth \\
+ \beta_{1,2}doseMedium \cdot time + \beta_{1,3}doseHigh \cdot time + \epsilon_i
\end{align*}

# Multivariate models

\footnotesize{
  \begin{table}[H]
  \centering
  \begin{tabular}{r|l|l|l|l|l}
  \hline
  & Variable & Estimate & Std. Error & t value & Pr($>$$|$t$|$) \\ 
  \hline
  $\beta_{0}$  & (Intercept) & 15.85 & 1.35 & 11.74 & $<$0.00001 \\ 
  $\beta_{1}$  & time & 2.43 & 0.66 & 3.67 & 0.0005 \\ 
  $\beta_{2}$  & doseM & -0.32 & 1.75 & -0.18 & 0.86 \\ 
  $\beta_{3}$  & doseH & -1.31 & 1.67 & -0.78 & 0.44 \\ 
  $\beta_{4}$ & nbirth & -0.34 & 0.13 & -2.51 & 0.01 \\ 
  $\beta_{1,2}$  & time:doseM & 0.48 & 0.9 & 0.54 & 0.59 \\ 
  $\beta_{1,3}$ & time:doseH & 2.35 & 0.84 & 2.8 & 0.007 \\ 
  \hline
  \end{tabular}
  \footnotesize{\caption{Multivariant model fitted.}
                \label{taulamodels}
  }
  \end{table}
}

\pause

\vspace{-0.5cm}
> - Validation: residuals analysis.

> - Assumptions are not satisfied.

> - Although, first idea or insight of the influence of each variable.


# Two Stage Analysis


__Stage 1 Model__

$PCV_{ij} = \beta_{0ij} + \beta_{1ij}time + \epsilon_{ij}$ and $\epsilon_{ij} \sim N(0, \Sigma_ij)$



# Two Stage Analysis

```{r two_stage_graph, fig.cap = "Each line represents the linear model fited for each cow and dose.\\label{fig:two_stage_graph}"}
# Graph option 1
# q <- qplot(factor(time), pcv, group = id, data = cows.com, geom = c("point", "line")) + facet_grid(dose ~ id)
# q + geom_abline(aes(intercept = Intercept, slope = slope), colour = "red", data = bdd, alpha = 0.8)

# bdd$doseExt <- factor(bdd$dose, labels = c("Low", "Medium", "High"))
# Graph option 2
q <- qplot(factor(time), pcv, group = id, data = cows.com, geom = "point") + facet_grid(.~ doseExt)
# q + geom_abline(aes(intercept = Intercept, slope = slope, colour = factor(doseExt)), data = bdd) + xlab("time") + ylab("PCV value")
```

__Stage 2 Model__

$\beta_{0ij} = \beta_0 + \beta_1 doseMedium + \beta_2 doseHigh + b_{0ij}$

$\beta_{1ij} = \beta_3 + \beta_4 doseMedium + \beta_5 doseHigh + b_{1ij}$

where $b_i \sim N(0, D)$

\footnotesize{

\begin{table}[H]
\centering
\begin{tabular}{lll}

\hline
Parameters            & Estimate (p-value)       \\ 
\hline
$\beta_{0}$ (Intercept)  & 15.1300 (\textless 2e-16) \\
$\beta_{1}$ (doseMedium) & -0.6448 (0.5237)         \\
$\beta_{2}$ (doseHigh)   &  -2.0667 (0.0429)   \\   
\hline
$\beta_{3}$ (Intercept)   & 2.1500 (0.000438)  \\
$\beta_{4}$ (doseMedium) &  0.4500 (0.540909)  \\
$\beta_{5}$ (doseHigh)  &  2.6300 (0.001083)  \\
\hline
\end{tabular}
\caption{Two-stage analysis results of model fitting of $\beta_{0ij}$}
\label{tab::Two_stage_intercept}
\end{table}
}

\footnotesize{
\begin{table}[H]
\centering
\begin{tabular}{ll}
\hline
Parameters   & Estimate (p-value)       \\ 
\hline
$\beta_{3}$ (Intercept)   & 2.1500 (0.000438)  \\
$\beta_{4}$ (doseMedium) &  0.4500 (0.540909)  \\
$\beta_{5}$ (doseHigh)  &  2.6300 (0.001083)  \\
\hline
\end{tabular}
\caption{Two-stage analysis results of model fitting of $\beta_{1ij}$}
\label{tab::Two_stage_slope}
\end{table}
}

# Linear Mixed Models











# Conclusion
