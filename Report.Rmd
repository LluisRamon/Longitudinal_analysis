---
title: "Study of the efficacy of Berenil applied to trypanosomosis's infected cattle"
author: "Gerard Castell√†, Mathieu Marauri and Lluis Ramon"
date: \today
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
---

```{r, echo = FALSE, warning = FALSE, message = FALSE}
library("knitr")
library("ggplot2")
library("xtable")
library("dplyr")
library("nlme")
opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE)
```

```{r}
cows <- read.table("data/cattle_mes dades.txt", header = TRUE, 
                   sep = "\t", dec = ",", na.strings = "")

names(cows) <- c("id", "dose", "pcv", "time", "nbirth")
cows$dose <- factor(cows$dose, levels = c("L", "M", "H"))
```


# Introduction

Cattle are an important economic resource and also a major health factor in many countries. Therefore preventing diseases in a herd is vital. 

In this study we focus our interest on the parasite of trypanosomosis which can lead to the death of a cow. This disease, transmitted by the tsetse flies, causes an infection characterized by fever, loss of apetite and anaemia, which can lead to death depending on different factors.

One medicine, the Berenil, is used to cure the infected cattle. The aim of this research is to determine the efficiency of different doses of Berenil. Finding the most efficient dose, if such a dose exists, is critical when it comes to save both cattle and money. Here lies all the interest of our study. 

To assess the severity of the disease, the Packed-Cell Volume (PCV) is shown to be a good indicator. The PCV is the percentage of red blood cells in blood. The lower the PCV is, the less healthy the cow is. 

# Objective

The aim of this study is to assess the efficacy of different doses of Berenil in cattle infected with the trypanosomosis parasite.

# Dataset

A cohort of 10 different cows infected by trypanosomosis parasite was selected for the study. Each  Berenil dose (low, medium and high) was administrated three times (time 1, 2 or 3) for each animal. PCV was reported each time as well as the number of calves it had before being infected.

The variables reported for this study are presented below.

* Id: Each cow has its own id. From 1 to 10. _(id)_
* PCV: From 14.30 to 33.30. _(pcv)_
* Dose: H High, M Medium L low. _(dose)_
* Time: From 1 to 3. _(time)_
* Number of birth: From 2 to 8. _(nbirth)_

Since the gathering process of the data was unkonw, several assumptions were needed.

* Each time PCV is obtained before the treatment. Therefore the effect of the third dose could not be evaluated.
* Dose is assigned randomly in time to the cow.
* For a given cow, the previous treatments (high, medium or low) do not affect the following ones.
* Missings are complitely at random.
* Time intervals are the same and fixed.

# Statistical methods

The methods used in the statistical analyses are detailled in this section. First a multivariate model was fitted, then a two stage analysis and finally a random effect model. An exploratory data analysis was performed before those regression methods.

## Multivariate model

Despite the fact of not being the optimal choice, a multivariate linear model was fitted to the data. It seems reasonable to think that observations are not independent, since they are comming from the same cow. However, this model could also led to some interesting results.

The response variable was PCV since the severity the disease was evaluated by this parameter. As we wanted to estimate the effect of dose in diseased cows in time, these two variables were included in the model. 

From this initial model, a forward stepwise method was carried for the model selection,  including additional covariates or interactions between them. The models were compared using F-test. This procedure was followed until no other covariates or interactions below 3rd order could be added, because they would not produce a significantly better model. Leading this to the most parsimonious model with all significant variables.

A validation of the model was performed to check that the residuals were normal, homoscedastic and independent between them and to other rellevant covariates. 

## Two-stage analysis

A Two-stage analysis was performed to take into acount variability between subjects.

In the first stage model, 3 linear regression models were done for each subject separately, one for each dose (High, Medium, Low).  The response variable  was PVC and time the covariate. 

In the second stage model, a linear regression model was fitted for the subject-specific regression coefficients using dose as a covariate. It was also studied the cow effect or the number of births effect.

## Random-effects model

Since the Two Stage model didn't take into acount the within subjects variability, a Random-effects model was fitted. 

It distinguishes the mean structure of the covariates as a fixed effect and also some variability between and within subjects as a random effects. It allows more flexibility to model.

The methodology for model selection was the following as proposed by Verbeke and Molenberghs:

1. Selection of a Preliminary Mean Structure
2. Selection of a Preliminary Random-Effects Structure
3. Selection of a Residual Covariance Structure
4. Model Reduction

A validation of the model was performed to check that the residuals were normal, homoscedastic and independent between them and to other rellevant covariates. 


# Summary statistics

In this part the aim is to have some insights about the data. By performing a basic statistical analysis some relations between the explaining variables and the response one would emerged. A first idea on how we can explain the response variable and also some answers when it comes to discovering the most efficient dose.

```{r qplot, fig.cap = "PCV evolution for each cow on every dose. Cows are colored in the same fashion for each dose. \\label{fig:qplot}"}
qplot(factor(time), pcv, data = cows, group = id, geom = "line", facets = .~ dose, 
      colour = factor(id)) + scale_color_discrete(guide = 'none')
```


PCV values seem similar for each dose at time 1, which makes sense with several assumptions previously stated. Especially the fact that the PCV is taken before treatment. The unfinished evolutions in Figure \ref{fig:qplot} represent missing values in the data, more details about missing data are reported in the section \ref{sec:Missings}. Notice that several cows with low PCV values in Low dose also have low PCV values in the other doses. 

Cows treated with high doses tend to have a better evoloution in their PCV values. One could also think that time has an influence on the PCV in the way that the effect of the second dose seems to be less important than the first one. 


The mean influence of the covariate *time* is expected to be positive. Indeed one expects to higher PCV values after treatment. Also the High dose is expected to be more efficient than the Medium and Low one. This can be verified in Figure \ref{fig:boxplot_time_dose}.

```{r boxplot, fig.cap = "Boxplot of PCV values for each time and dose. \\label{fig:boxplot_time_dose}"}
cows$timeDose <- paste(cows$time, cows$dose, sep = ".")
cows$timeDose <- factor(cows$timeDose, levels = c("1.L", "2.L", "3.L", "1.M", "2.M", "3.M", "1.H", "2.H", "3.H"))
ggplot(aes(timeDose, pcv, fill = dose), data = cows) + geom_boxplot()
cows$timeDose <- NULL
```

In Figure \ref{fig:boxplot_time_dose} it can be apreciated that there is not a big difference between the low and the medium doses. However the High dose is much better than the others. For instance the mean PCV value at time 2 for the High dose is bigger than mean PCV value at time 3 for the Medium or Low dose.

## Number of births

None of the cows gave birth after time 1 of the first infection. So the number of births remains constant through all doses and times for each cow. 

Some boxplots were performed but it didn't show any clear result, although a tendency may be seen at time 1. A simple regression model was also fit at time 1 with a significant (p = 0.007) a slope  of -0.3444. It may explain the fact that a cow is supposed to be weaker if it had a lot of calves. Latter on the analysis the nbirth effect will be combined with other variables.

```{r, eval = FALSE}
lcowsnbirth <- lm(pcv ~ nbirth, data = cows[cows$time == 1,])
summary(lcowsnbirth)
```

## Missing data analysis
\label{sec:Missings}

There are 14 missing PCV values out of 90 observations in the dataset. Those missing values are equally distributed among doses and time as it is shown in Table 1.

```{r, results = 'asis'}
cows.com <- na.omit(cows)
missingsTable <- 10 - table(cows.com$dose, cows.com$time)
xtable(missingsTable, digits = 0, caption = "Number of missings in PCV for time and dose")
```

It seems to be a contradiction with the assumption that missings are randomly distributed. In the study all those missings will be removed and not further analyzed nor imputed.

## Correlation structure

```{r}
library("corrplot")
library("tidyr")
cows.w <- spread(cows, time, pcv)
corrplot(cor(cows.w[, c("1", "2", "3")], use = "pairwise.complete.obs"), "ellipse")
```


# Results

Each cow in this dataset was treated three times, hence we will, at the beginning at least, consider that our dataset contains 30 different cows identified by id and dose. Later on this assumption will be released. The idea behind this differentiation within the same cow is due to the fact that a different Berenil dose was given for each infection. That is to say each cow has been infected three different times by the parasite.

## Multivariate model


```{r, echo=FALSE, results='hide'}
round.pval <- function(pval=stop("p-value not given"), show.sig.stars=FALSE, alpha=0.05){
  
  arrodonir <- function(pval, show.sig.stars, alpha){
  	
		if(is.na(pval)) return(NA)

		ndec <- nchar(as.character(signif(alpha,1)))-2
		pval2 <- if(pval >= alpha) round(pval, ndec) else signif(pval, 1)

		i <- 1
		while(pval2==signif(alpha, i)){
			pval2 <- round(pval, ndec+i)
			if(pval2==pval) break
			i <- i+1
		}
		pval2 <- format(pval2, scientific=F)
		if(pval<0.00001){
			pval2 <- "<0.00001"
		}
		
		if(show.sig.stars){
			cpoints <- c(0, alpha/50, alpha/5, alpha, ceil(alpha*10^(ndec-1))/10^(ndec)+alpha, 1)
			c(0, 0.001, 0.01, 0.05, 0.1, 1)
			pval2 <- paste(pval2, symnum(pval, corr = FALSE, na = FALSE, cutpoints = cpoints, symbols = c("***", "**", "*", ".", " ")))
		}

		return(pval2)
	}

	ret <- sapply(pval, function(x) arrodonir(x, show.sig.stars=show.sig.stars, alpha=alpha))
	if(is.matrix(pval)) ret <- matrix(ret, ncol=ncol(pval))
	return(ret)

}

cows <- read.table("data/cattle_mes dades.txt", header = TRUE, 
                   sep = "\t", dec = ",", na.strings = "")

names(cows) <- c("id", "dose", "pcv", "time", "nbirth")

cows$id <- as.factor(cows$id)
cows$dose <- factor(cows$dose, levels=c("L", "M", "H"))

# dep variable:
# pcv: the higher the better.

# indep variables:
# dose: we want to know if the dose is associated with lower PCV
# nbirth: we want to know if this covariate influences the effect of the dose.
# time: we dont particularly want to see differences in time, but maybe 
# 3rd observations of the doses are higher, ...

# we do not want:
# id: we dont want the effect of the dose to be explained by the cow.

# Each observation of each cow will be considered independent.
taula <- matrix(ncol=6, nrow=19)
model <- lm(pcv ~ time + dose, data=cows)
summary(model)
model0 <- model
colnames(taula) <- c("Formula", "Variables", colnames(summary(model)$coef))
as.character(model$terms)->formu
taula[1,1] <- paste(formu[c(2,1,3)], collapse="")
taula[1:4,-(1:2)] <-  summary(model)$coef
taula[1:4,2] <- rownames(summary(model)$coef)

model <- lm(pcv ~ time*dose, data=cows)
summary(model)
model1 <- model
as.character(model$terms)->formu
taula[6,1] <- paste(formu[c(2,1,3)], collapse="")
taula[6:11,-(1:2)] <-  summary(model)$coef
taula[6:11,2] <- rownames(summary(model)$coef)
# dose H has a huge effect, in a possitive way. Also, in general higher
# times give better PCV values (which is logical). nbirth has a significative
# negative effect on the PCV.

model <- lm(pcv ~ time*dose + nbirth, data=cows)
summary(model)
model2 <- model
as.character(model$terms)->formu
taula[13,1] <- paste(formu[c(2,1,3)], collapse="")
taula[13:19,-(1:2)] <-  summary(model)$coef
taula[13:19,2] <- rownames(summary(model)$coef)
# time and dose almost interact for high doses. This interaction is synergistic.
# higher times and dose H give even higher pcv, but this effect is higher when 
# combined together.

model <- lm(pcv ~ dose + time*nbirth, data=cows)
summary(model)
as.character(model$terms)->formu
model <- lm(pcv ~ time + dose*nbirth, data=cows)
summary(model)
# no other interactions are significative.
taula[,6] <- round.pval(as.numeric(taula[,6]))
taula[,3:5] <- round(as.numeric(taula[,3:5]), 2) 
# print(xtable(taula, digits=c(0,0,0,2,2,2,2)), include.rownames=F)
# so... model selection, for the more pasimonious model says...
add1(model0, scope=~.^2+nbirth, test="F")
add1(update(model0,~.^2), scope=~.+nbirth, test="F")
add1(model2, scope=~.^2, test="F")

## final model:
model2 <- lm(pcv ~ time*dose + nbirth, data=cows, y=T, model=T)
summary(model2)
anova(model2)
```

Table \ref{taulamodels} summarizes the results of the estimation of the parameters of all models considered with the forward stepwise method for model selection. The last one corresponds to the most parsimonious model that better explains the data, whose especification is the following:

$$
PCV= 15.82 + 2.43X_{time} -0.32X_{doseM} -1.31X_{doseH} -0.34X_{nbirth} + 0.48X_{doseM}X_{time} + 2.35X_{doseH}X_{time}
$$

Although the coefficients for the additive effects for both doses are negative, when adding the interaction term it ensures a possitive effect. The difference in PCV for the same cows treated with high dose with respect to low dose will be:

$$
PCV(X_{doseH}=1)-PCV(X_{doseL}=1) = -1.31+2.35X_{time} 
$$

Notice that this is a positive quantity for every time, so we can consider that the high dose has a bigger effect than low dose (both coefficients significantly different than 0). For the medium dose, although being also positive, the coefficients are not significant, so could be 0. This calculations are always with respect to the same cow, when being treated with different doses.

$$
PCV(X_{doseM}=1)-PCV(X_{doseL}=1) = -0.32+0.48X_{time} 
$$

Therefore, the effect of the dose then changes with the time in a synergistic way. 
Also, time has a possitive effect in the PCV, as it goes by PCV grows (p$<$0.00001). However the number of births seems to have a significant negative effect in the PCV (p=0.01).



\begin{table}[ht]
\centering
\begin{tabular}{llllll}

\hline
Formula & Variables & Estimate & Std. Error & t value & Pr($>$$|$t$|$) \\ 
  \hline
pcv\~{}time + dose & (Intercept) & 12.32 & 0.83 & 14.78 & $<$0.00001 \\ 
   & time & 3.55 & 0.37 & 9.63 & $<$0.00001 \\ 
   & doseM & 0.56 & 0.75 & 0.75 & 0.45 \\ 
   & doseH & 3.2 & 0.72 & 4.47 & 0.00003 \\ 
   &  &  &  &  &  \\ 
  pcv\~{}time * dose & (Intercept) & 14.51 & 1.29 & 11.28 & $<$0.00001 \\ 
   & time & 2.28 & 0.68 & 3.34 & 0.001 \\ 
   & doseM & -0.47 & 1.81 & -0.26 & 0.79 \\ 
   & doseH & -1.45 & 1.73 & -0.84 & 0.41 \\ 
   & time:doseM & 0.65 & 0.93 & 0.7 & 0.48 \\ 
   & time:doseH & 2.5 & 0.87 & 2.87 & 0.005 \\ 
   &  &  &  &  &  \\ 
  pcv\~{}time * dose + nbirth & (Intercept) & 15.85 & 1.35 & 11.74 & $<$0.00001 \\ 
   & time & 2.43 & 0.66 & 3.67 & 0.0005 \\ 
   & doseM & -0.32 & 1.75 & -0.18 & 0.86 \\ 
   & doseH & -1.31 & 1.67 & -0.78 & 0.44 \\ 
   & nbirth & -0.34 & 0.13 & -2.51 & 0.01 \\ 
   & time:doseM & 0.48 & 0.9 & 0.54 & 0.59 \\ 
   & time:doseH & 2.35 & 0.84 & 2.8 & 0.007 \\ 
   \hline
\end{tabular}
\caption{All multivariant models considered for fitting the data that were significantly different, using F-tests to assess this difference.}
\label{taulamodels}

\end{table}

The analyses of the residuals of the model can be seen in Figure \ref{resplots}. Clearly, they present some issues: residuals are not independent from PCV, are not centered for high dose, no homoscedasticity, etc. So even thought this is not the optimal model to fit the data (and this is also shown in the residuals plots), the model is pointing in a pretty obvious way that the high dose is the only one that an effect significantly different from low dose. One of the problems with the data is that there are no controls among the cows so, the effect of the doses cannot be compared with PCV without any treatment.


```{r, echo=FALSE, fig.cap='Analyses of the residuals of the model.\\label{resplots}'}
## diagnostic:
par(mfrow=c(2,2), mar=c(4,4,2,2), cex=0.6)
# high pcv has high positive errors. Doesnt seem to be random.
plot(model2$residuals, model2$y, xlab="residuals", ylab="PCV")
# problems with doseH
plot(model2$model$dose, model2$residuals, ylab="residuals", xlab="Dose")
# NO homoscedasticity
plot(model2$model$time, model2$residuals, ylab="residuals", xlab="Time")
# not centered
plot(model2$model$nbirth, model2$residuals, ylab="residuals", xlab="Number of births (nbirth)")

## BAD MODEL: we already know that, since obervations are not independent.
```



## Two stage analysis 

In this section a Two stage is performed, where a linear regression is done for each cow in the firs stage. Then, with the coefficients a second regression is done for the intercept and the slope conditioning on dose.

Several issues emerge with the missing values. As it was specified in missing data analysis section, there are several cows that have just pcv value at time 1, so it could not be possible to generate slope. For example cows number 6 and 9 treated with low dose. 

__Stage 1 Model__

$PCV_{ij} = \beta_{0ij} + \beta_{1ij}time + \epsilon_{ij}$ and $\epsilon_{ij} \sim N(0, \Sigma_ij)$


__Stage 2 Model__

$\beta_{0ij} = \beta_0 + \beta_1 doseMedium + \beta_2 doseHigh + b_{0ij}$

$\beta_{1ij} = \beta_3 + \beta_4 doseMedium + \beta_5 doseHigh + b_{1ij}$

where $b_i \sim N(0, D)$

```{r}
cows.com$idDose <- paste(cows.com$id, cows.com$dose, sep = "_")
cows.gd <- groupedData(pcv ~ time|idDose, data = cows.com, 
                       outer = ~dose, inner = ~nbirth)

cows.lmList <- nlme:::lmList(pcv ~ time, cows.gd)
betas <- as.data.frame(coef(cows.lmList))
names(betas) <- c("Intercept", "slope")

betas <- add_rownames(betas, var = "idDose")
betas.info <- cows.com %>% group_by(idDose, id, dose) %>% summarize(nbirth = mean(nbirth))
bdd <- left_join(betas, betas.info)

modbeta0 <- lm(Intercept ~ dose, bdd)
modbeta1 <- lm(slope ~ dose, bdd)
# summary(modbeta0)
# summary(modbeta1)
```

At Figure \ref{fig:two_stage_graph} it is shown all the linear regressions done at the first stage analysis. The slopes are positive for each dose but bigger for high dose treatment. Comparing this Figure with Figure \ref{fig:qplot} it can be seen that the information much variability is lost and the the data is reduced.

```{r two_stage_graph, fig.cap = "Each line represents the linear model fited for each cow and dose.\\label{fig:two_stage_graph}"}
# Graph option 1
# q <- qplot(factor(time), pcv, group = id, data = cows.com, geom = c("point", "line")) + facet_grid(dose ~ id)
# q + geom_abline(aes(intercept = Intercept, slope = slope), colour = "red", data = bdd, alpha = 0.8)

# Graph option 2
q <- qplot(factor(time), pcv, group = id, data = cows.com, geom = "point") + facet_grid(.~ dose)
q + geom_abline(aes(intercept = Intercept, slope = slope, colour = factor(dose)), data = bdd)
```

Parameter estimates for $\beta_{0ij}$ are included in Table \ref{tab::Two_stage_intercept} with it corresponding p-value. The intercept (15.1300) represents the mean PCV value at time 1 for a cow treated with low dose, as it is the reference treatment. The parameter estimate for medium dose is not significant. However the estimate for dose high (-2.0667) is significant and it means that the intercept for a cow treated with dose high would be 13.0633.

\begin{table}[ht]
\centering
\begin{tabular}{lll}

\hline
Parameters            & Estimate (p-value)       \\ 
\hline
$\beta_{0}$ (Intercept)  & 15.1300 (\textless 2e-16) \\
$\beta_{1}$ (doseMedium) & -0.6448 (0.5237)         \\
$\beta_{2}$ (doseHigh)   &  -2.0667 (0.0429)   \\            
\end{tabular}
\caption{Two-stage analysis results of model fitting of $\beta_{0ij}$}
\label{tab::Two_stage_intercept}
\end{table}

Parameter estimates for $\beta_{1ij}$ are included in Table \ref{tab::Two_stage_slope} with their corresponding p-value. The intercept (2.1500) representing the slope increases in time. As it was seen in the previous table, medium dose is not significant with respect to low dose. However, high dose is strongly significant with an estimate of 2.6300 which means that the slope for a cow treated with high dose would be 4.78.

\begin{table}[ht]
\centering
\begin{tabular}{ll}
\hline
Parameters   & Estimate (p-value)       \\ 
\hline
$\beta_{3}$ (Intercept)   & 2.1500 (0.000438)  \\
$\beta_{4}$ (doseMedium) &  0.4500 (0.540909)  \\
$\beta_{5}$ (doseHigh)  &  2.6300 (0.001083)  \\      
\end{tabular}
\caption{Two-stage analysis results of model fitting of $\beta_{1ij}$}
\label{tab::Two_stage_slope}
\end{table}


## Random effects



$PCV_{i} = (\beta_{0} + b_{0i}) + (\beta_{1} + b_{1i})time + \beta_2 doseMedium + \beta_3 doseHigh + \beta_4 numbirths + \epsilon_{i}$ and $\epsilon_{i} \sim N(0, \Sigma_ij)$


# Discussion

Giving birth is supposed to weaken the cow, besides *nbirth* is also an indicator of how old the cow is.


# Limitations and Further research

# Bibliography

* [Bovine trypanosomiasis in south-western Uganda: packed-cell volumes and prevalences of infection in the cattle.](http://www.ncbi.nlm.nih.gov/pubmed/15000727)
* [Evaluating the use of packed cell volume as an indicator of trypanosomal infections in cattle in eastern Zambia](http://www.sciencedirect.com/science/article/pii/S0167587708001098#)
* [Linear Mixed Models for Longitudinal Data](http://www.springer.com/gp/book/9781441902993)